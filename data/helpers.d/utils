# Extract a key from a plain command output
#
# example: yunohost user info tata --output-as plain | ynh_get_plain_key mail
#
# usage: ynh_get_plain_key key [subkey [subsubkey ...]]
# | ret: string - the key's value
ynh_get_plain_key() {
    prefix="#"
    founded=0
    key=$1
    shift
    while read line; do
        if [[ "$founded" == "1" ]] ; then
            [[ "$line" =~ ^${prefix}[^#] ]] && return
            echo $line
        elif [[ "$line" =~ ^${prefix}${key}$ ]]; then
            if [[ -n "${1:-}" ]]; then
                prefix+="#"
                key=$1
                shift
            else
                founded=1
            fi
        fi
    done
}

# Download and uncompress the source from app.src
#
# The file conf/app.src need to contains:
# 
# SOURCE_URL=Address to download the app archive
# SOURCE_SUM=Control sum
# ARCH_FORMAT=tar.gz or zip
#
# usage: ynh_setup_source [source_id]
# | arg: source_id - Name of the app, if the package contains more than one app
ynh_setup_source () {
	source_id=${1:-app} # If the argument is not given, source_id equal "app"
	src_url=$(cat ../conf/${source_id}.src | grep SOURCE_URL | cut -d= -f2-)
	src_checksum=$(cat ../conf/${source_id}.src | grep SOURCE_SUM | cut -d= -f2-)
	arch_format=$(cat ../conf/${source_id}.src | grep ARCH_FORMAT | cut -d= -f2-)
	local_source="/opt/yunohost-apps-src/$YNH_APP_ID/source.$arch_format"

	if test -e "$local_source"
	then	# Use the local source file if it is present
		cp $local_source source.$arch_format
	else	# If not, download the source
		wget -nv -O source.$arch_format $src_url
    fi

	# Check the control sum
	echo "$src_checksum source.$arch_format" \
		| md5sum -c --status || ynh_die "Corrupt source"

	# Extract source into the app dir
	sudo mkdir -p "$final_path"
	if [ $(echo "$arch_format" | tr '[:upper:]' '[:lower:]') = "zip" ]
	then # Zip format
		# Using of a temp directory, because unzip doesn't manage --strip-components
		temp_dir=$(mktemp -d)
		unzip -quo source.zip -d "$temp_dir"
		sudo cp -a $temp_dir/*/. "$final_path"
		ynh_secure_remove "$temp_dir"
	elif [ $(echo "$arch_format" | tr '[:upper:]' '[:lower:]') = "tar.gz" ]; then
		sudo tar -x -f source.tar.gz -C "$final_path" --strip-components 1
	else
		ynh_die "Format d'archive non reconnu."
	fi

	# Apply patches
	if test -f ../sources/patches/${source_id}-*.patch; then
		(cd "$DEST" \
			&& for p in ${PKG_DIR}/patches/${source_id}-*.patch; do \
				sudo patch -p1 < $p; done) \
			|| ynh_die "Unable to apply patches"
	fi

	# Add supplementary files
	if test -e "../sources/extra_files"; then
		sudo cp -a ../sources/extra_files/. "$final_path"
	fi
}
